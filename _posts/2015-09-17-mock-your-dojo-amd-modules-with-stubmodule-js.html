---
layout: post
status: publish
published: true
title: Mock your Dojo AMD modules with StubModule.js
author:
  display_name: Scott Davis
  login: Scott Davis
  email: stdavis@utah.gov
  url: ''
author_login: Scott Davis
author_email: stdavis@utah.gov
wordpress_id: 17945
wordpress_url: http://gis.utah.gov/?p=17945
date: '2015-09-17 07:41:59 -0600'
date_gmt: '2015-09-17 13:41:59 -0600'
categories:
- Developer
tags:
- javascript
---
<p>When testing AMD modules it is sometimes necessary to verify how it interacts with it&#39;s dependencies. For example, you might be writing a module that makes XHR requests using <a href="http://dojotoolkit.org/reference-guide/dojo/request.html#dojo-request">dojo/request</a> and you want to make sure that it&#39;s passing the correct parameters. How would you test this? Creating a wrapper around the request method in your module and then spying on that method would work. You could also store the request method as a property of your module and spy on that in your tests. However, both of these solutions lead to messy code and there&#39;s something that feels wrong to me when adding code to production modules just for testing purposes.</p>
<p>You might think that it would be as easy as adding a <a href="http://dojotoolkit.org/reference-guide/loader/amd.html#id9">map config to the Dojo loader</a> and pointing dojo/request to a mocked module. While this is a possible solution it means that you have to create a separate file for each mock that you use and it gets very messy if you want to mock the same module multiple times within a single test page (since modules are cached by the loader).</p>
<p><a href="https://github.com/agrc/StubModule">StubModule.js</a> provides a cleaner way to solve this problem. It allows you to stub modules with no dependencies on external files and no side effects to pollute your other tests. It does this by using the map config mentioned above as well as <a href="http://dojotoolkit.org/reference-guide/loader/amd.html#id12">require.undef</a> which is a Dojo-specific method that removes a module from the cache.</p>
<p>Using this tool is fairly straight forward. stub-module.js returns a single method that accepts two parameters. The first is the module identifier (MID) of the module that you want to test. The second is an object with keys that are MID&#39;s of the dependencies that you want to mock and values that are the mocked returned values. The method returns a <a href="http://dojotoolkit.org/reference-guide/dojo/promise.html">promise</a> that resolves with the stubbed module. For example (using <a href="http://jasmine.github.io/">Jasmine</a>):</p>
<pre class="editor-colors lang-js"><div class="line"><span class="source js"><span>it</span><span class="meta brace round js"><span>(</span></span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>this&nbsp;is&nbsp;a&nbsp;demo</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="punctuation definition parameters begin js"><span>(</span></span><span class="variable parameter function js"><span>done</span></span><span class="punctuation definition parameters end js"><span>)</span></span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier js"><span>var</span></span><span>&nbsp;stub&nbsp;</span><span class="keyword operator js"><span>=</span></span><span>&nbsp;jasmine</span><span class="meta delimiter method period js"><span>.</span></span><span>createSpy</span><span class="meta brace round js"><span>(</span></span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>request</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;stubModule</span><span class="meta brace round js"><span>(</span></span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>test/Module</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>dojo/request</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="keyword operator js"><span>:</span></span><span>&nbsp;stub</span><span class="meta brace curly js"><span>}</span></span><span class="meta brace round js"><span>)</span></span><span class="meta delimiter method period js"><span>.</span></span><span>then</span><span class="meta brace round js"><span>(</span></span><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="punctuation definition parameters begin js"><span>(</span></span><span class="variable parameter function js"><span>StubbedModule</span></span><span class="punctuation definition parameters end js"><span>)</span></span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier js"><span>var</span></span><span>&nbsp;testObject&nbsp;</span><span class="keyword operator js"><span>=</span></span><span>&nbsp;</span><span class="meta class instance constructor"><span class="keyword operator new js"><span>new</span></span><span>&nbsp;</span><span class="entity name type instance js"><span>StubbedModule</span></span></span><span class="meta brace round js"><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testObject</span><span class="meta delimiter method period js"><span>.</span></span><span>makeRequest</span><span class="meta brace round js"><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expect</span><span class="meta brace round js"><span>(</span></span><span>stub</span><span class="meta brace round js"><span>)</span></span><span class="meta delimiter method period js"><span>.</span></span><span>toHaveBeenCalledWith</span><span class="meta brace round js"><span>(</span></span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>some/url</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;done</span><span class="meta brace round js"><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="meta brace curly js"><span>}</span></span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></pre>
<p>To be honest I was surprised that I couldn&#39;t find an existing project that met my use case before I wrote this project. Did I miss something? Also, I wonder if the API of this project could be simplified. Any suggestions?</p>
